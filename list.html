<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
		<meta name="format-detection" content="telephone=no" />
		<title></title>
		<link rel="stylesheet" type="text/css" href="css/common.css"/>
		<link rel="stylesheet" type="text/css" href="css/list.css"/>
	</head>
	<body>
		<div id="container2" class="transparent opacityTrans">
			<header>
				<div id="bodyMask"></div>
				<div id="headerInner">
					<div id="logo" class="none">
						<a href="javascript:;">
							<img src=""/>
						</a>
					</div>
					<div id="title" class="none">
						<a href="javascript:;"></a>
					</div>
					<div id="menuBtn" class="none">
						<div class="menuBar" id="menuBar_1"></div>
						<div class="menuBar" id="menuBar_2"></div>
						<div class="menuBar" id="menuBar_3"></div>
					</div>
				</div>
				<div id="menuWrap">
					<div id="dingyun"></div>
					<div id="menuList">
						<div id="menuListInner">
						</div>
					</div>
				</div>
			</header>
			<nav id="wrapper">
				<div id="navInner" class="hide">
					<!--<div class="channelBtn active">网罗美食</div>
					<div class="channelBtn">丽人频道</div>
					<div class="channelBtn">运动健身</div>
					<div class="channelBtn">娱乐八卦</div>
					<div class="channelBtn">新闻资讯</div>
					<div class="channelBtn">文化热点</div>-->
				</div>
			</nav>
			<section id="listSec">
				<div id="listWrap">
					<div id="listWrapInner">
						<!--<div class="artLi">
							<a href="http://www.baidu.com">
								<div class="artLiImg">
									<img src="img/tree.jpg" alt="" />
								</div>
								<div class="artLiTitle">最值得一吃的小点心Cupcake盘点</div>
								<div class="artLiTime">2016-05-10</div>
								<div class="artLiDesc">Colibri Café别名蜂鸟，它可算是北京Cupcake的鼻祖了，在Cupcake店还不多的时候，就已横空出世，到现在依然是人满为患。</div>
							</a>
						</div>
						<div class="artLi">
							<div class="artLiImg">
								<img src="img/runimg_1.jpg" alt="" />
							</div>
							<div class="artLiTitle">外国人超爱的上海西餐厅Top10</div>
							<div class="artLiTime">2016-02-16</div>
							<div class="artLiDesc">Hai by Goga  澳大利亚会员Tony Stark:食物出乎意料地好吃，露台很惊艳，朝外能看到大半个上海的夜景，繁华尽收眼底。登、有趣的方式去烹制食物，推荐霜烧牛肉、芥末吞拿、松露薯条、芝士汉堡。</div>
						</div>
						<div class="artLi">
							<div class="artLiImg none"></div>
							<div class="artLiTitle">“黑暗料理”大对决 奇葩吃法欢乐多,哈哈哈哈欢乐多欢乐多欢乐多欢乐多欢乐多欢乐多</div>
							<div class="artLiTime">2015-11-22</div>
							<div class="artLiDesc">简介：Hai by Goga  澳大利亚会员Tony Stark:食物出乎意料地好吃，露台很惊艳，朝外能看到大半个上海的夜景，繁华尽收眼底。登、有趣的方式去烹制食物，推荐霜烧牛肉、芥末吞拿、松露薯条、芝士汉堡。</div>
						</div>
						<div class="artLi">
							<div class="artLiImg none"></div>
							<div class="artLiTitle">牛油果史上最全吃法攻略</div>
							<div class="artLiTime">2015-05-26</div>
							<div class="artLiDesc none"></div>
						</div>-->
					</div>
					<div class="loading">
						<span class="mui-spinner"></span>
					</div>
					<div id="tips">
						该频道暂无文章！
					</div>
					<footer class="">
						<div id="diyun"></div>
						<div id="copyright">版权所有©BlueMP技术支持</div>
					</footer>
				</div>
			</section>
		</div>
		<script src="js/zepto.min.js"></script>
		<script src="js/iscroll.js"></script>
		<script src="js/common.js"></script>
		<script src="fake.js"></script>
		<script>
			document.onselectstart = new Function('event.returnValue=false;');
			var currPage = 1;
			$('#listWrapInner').on('click','.artLi',function(){
				console.log(111);
				window.location.href = $(this).find('a').attr('href');
			});
			function appendList(list){
				var listWrapInner = $('#listWrapInner');
                for(var j=0;j<list.length;j++){
					var li = $('<div class="artLi">'+
									'<a href="'+list[j].href+'" >'+
										'<div class="artLiImg">'+
											'<img src="" alt="" />'+
										'</div>'+
										'<div class="artLiTitle"></div>'+
										'<div class="artLiTime"></div>'+
										'<div class="artLiDesc"></div>'+
									'</a>'+
								'</div>');
					listWrapInner.append(li);
					//标题
                	var title = list[j].title;
                	var titleEle = li.find('.artLiTitle');
                	if(title){
                		titleEle.html(title);
                	}else{
                		titleEle.addClass('none');
                	}
					//封面图
                	var pic = list[j].pic;
                	var imgEle = li.find('img');
                	if(pic){
                		imgEle.attr('src',pic);
				        imgEle[0].onload = function(){
				        	if(listScroll){
								listScroll.refresh();
							}
				        };
                	}else{
                		imgEle.addClass('none');
                	}
                	//更新时间
                	var updatetime = list[j].updatetime;
                	var timeEle = li.find('.artLiTime');
                	if(updatetime){
                		timeEle.html(formatDate(updatetime));
                	}else{
                		timeEle.addClass('none');
                	}
                	//摘要
                	var summary = list[j].summary;
                	var summaryEle = li.find('.artLiDesc');
                	if(summary){
                		summaryEle.html(summary);
                	}else{
                		summaryEle.addClass('none');
                	}
                }
                if(listScroll){
					listScroll.refresh();
				}
			}
			function checkScrollPC(){
				var h = $('#listSec').height(),
					t = $('#listSec')[0].scrollTop,
					sh = $('#listSec')[0].scrollHeight;
				if(sh-t-h<rfSize){
					requestNextPage();
				}
			}
			function checkScroll(){
				if(listScroll.y - listScroll.maxScrollY < rfSize && listScroll.directionY>0){
					requestNextPage();
				}
			}
			function requestNextPage(){
           		if(!requesting && !allLoaded){
           			requesting = true;
					$('.loading').removeClass('hide');
			        articleList.getNextPage({cid:bluemp_cid,page:currPage++},function(data){
	           					requesting = false;
			        			$('.loading').addClass('hide');
			        			if(data){
			        				var len = data.length;
				        			if(len<pageSize){
				        				allLoaded = true;
				        			}
									if(data.length>0){
										appendList(data);
									}
			        			}
							});
           		}
			}
			var articleList;
			var requesting = true;
			$(function(){
				//setTimeout(function(){
					document.body.addEventListener('touchmove', function(event) {
						event.preventDefault();
					}, false);
					var storedCid = sessionStorage.cid;
					console.log(storedCid);
					if(storedCid){
						bluemp_cid = parseInt(storedCid);
						sessionStorage.removeItem('cid');
					}
					new bluemp.block.breadcrumb({
						type:1,
						isDefault: false,
						fnSuccess: function(data) {
							console.log(data);
							if(data && data.index_href){
								$('#logo a,#title a').attr('href',data.index_href);
							}
						}
					});
					initExtendInfo();
					initTitle();
					initHeader();
					navScroll = new IScroll('#wrapper', { 
						scrollX: true, scrollY: false, mouseWheel: true ,
						preventDefault: false
					});
					if(!hasTouch){
						$('#listSec').css('overflow-y','auto').on('scroll',checkScrollPC);
					}else{
						listScroll = new IScroll('#listSec', {
							mouseWheel: true,
							preventDefault: false,
							preventDefaultException: { tagName: /^A$/ }
						});
						listScroll.on("scrollMove",function(){
							checkScroll();
						});
						listScroll.on("scrollEnd",function(){
							console.log('scrollEnd');
							checkScroll();
						});
					}
					
					layout();
					
					initArtList();
					
					new bluemp.block.channelList({
						isDefault: false,
						fnSuccess: function(data) {
							var navInner = $('#navInner');
							if(data){
								var totalW = 0, startPos = 0, activeIdx;
								for(var i=0;i<data.length;i++){
									var navEle = $('<div class="channelBtn" >'+data[i].name+'</div>');
									var id = data[i].id;
									console.log(id,bluemp_cid );
									if(id==bluemp_cid){
										console.log('###################################');
										activeIdx = i;
										navEle.addClass('active');
									}
									navInner.append(navEle);
									var temp = navInner[0].offsetHeight;
									var w = navEle[0].offsetWidth/rfSize;
									totalW += w;
									if(i>0){
										totalW += .5;
									}
									navs.push({id:id,width:w,start:startPos});
									startPos += w+.25;
								}
								if(activeIdx!=undefined){
									channelExist = true;
									navInner.removeClass('hide');
									if(articleData){
										initArtListDo();
									}
									navInner.css('width',Math.ceil(totalW)+'rem');
									navScroll.refresh();
									var scrollToX;
									var storedX = sessionStorage.navScrollPos;
									if(storedX){
										scrollToX = parseFloat(storedX);
										sessionStorage.removeItem('navScrollPos');
									}else{
										scrollToX = -navs[activeIdx].start*rfSize;
									}
									var maxX = navScroll.maxScrollX;
									scrollToX = scrollToX<maxX?maxX:scrollToX;
									navScroll.scrollTo(scrollToX,0,0);
									navInner.on('click','.channelBtn',function(){
										var ele = $(this);
										if(!ele.is('active')){
											var btns = $('.channelBtn');
											btns.removeClass('active');
											ele.addClass('active');
											/*sessionStorage.cid = navs[btns.index(ele)].id;
											sessionStorage.navScrollPos = navScroll.x;*/
											/*window.location.reload();*/
											bluemp_cid = navs[btns.index(ele)].id;
											allLoaded = false;
											$('#listWrapInner').empty();
											$('#tips').css('display','none');
											$('.loading').removeClass('fix').removeClass('hide');
											if(listScroll){
												listScroll.refresh();
											}
											initArtList();
										}
									});
								}else{
									channelExist = false;
									$('.loading').addClass('hide');
									$('#tips').html('频道内容无法显示！').css('display','block');
								}
							}
						}
					});
				$('#container2').removeClass('transparent');
				//},1000);
			});
			var articleData;
			function initArtListDo(){
				requesting = false;
	               $('.loading').addClass('hide');
	               if(articleData){
		                var len = articleData.length;
	        			if(len<pageSize){
	        				allLoaded = true;
	        			}
		                if(len>0){
		                	if(articleData[0].cid==bluemp_cid){
				           		$('.loading').addClass('fix');
				           		appendList(articleData);
		                	}
		                }else{
		               		$('#tips').css('display','block');
		                }
	               }
			}
			function initArtList(){
				articleList = new bluemp.block.articleList({
		            isDefault: false,
		            fnSuccess: function(data) {
		               	articleData = data;
		                if(channelExist==true){
		                	initArtListDo();
		                }
		            }
		        });
			}
			var navs = [];
			var winW, winH, rfSize = 40;
			var navScroll, listScroll;
			var pageSize = 20, allLoaded = false;
			function layout(){
				updateSize();
				if(listScroll){
					listScroll.refresh();
				}
				navScroll.refresh();
			}
		</script>
	</body>
</html>
